<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>試卷計分互動系統</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .section-title {
            font-size: 1.3rem;
            color: #3498db;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .parts-container {
            margin-top: 20px;
        }
        
        .part {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .part-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .part-title {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .part-total {
            background-color: #3498db;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .question {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        
        .question-number {
            width: 40px;
            font-weight: bold;
        }
        
        .question-score {
            width: 100px;
            margin-right: 10px;
        }
        
        .question-obtained {
            width: 100px;
            margin-right: 10px;
        }
        
        .totals {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            text-align: center;
        }
        
        .totals h3 {
            margin-bottom: 10px;
        }
        
        .totals div {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .delete-btn {
            background-color: transparent;
            color: #e74c3c;
            font-size: 18px;
            padding: 5px;
        }
        
        .paper-list {
            margin-top: 20px;
        }
        
        .paper-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        
        .paper-item:hover {
            background-color: #f8f9fa;
        }
        
        .paper-info {
            flex-grow: 1;
        }
        
        .paper-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .paper-details {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .paper-actions {
            display: flex;
            gap: 10px;
        }
        
        .hidden {
            display: none;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            border-bottom: 3px solid #3498db;
            color: #3498db;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .question {
                flex-wrap: wrap;
            }
            
            .question-number, .question-score, .question-obtained {
                margin-bottom: 5px;
            }
            
            .part-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .part-header > div {
                margin-bottom: 10px;
            }
            
            .paper-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .paper-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>試卷計分互動系統</h1>
        
        <!-- 標籤頁 -->
        <div class="tabs">
            <div class="tab active" data-tab="create">創建試卷</div>
            <div class="tab" data-tab="list">試卷列表</div>
        </div>
        
        <!-- 創建試卷頁面 -->
        <div class="tab-content active" id="create-tab">
            <!-- 科目設定區域 -->
            <div class="section">
                <div class="section-title">
                    <span>科目設定</span>
                </div>
                <div class="input-group">
                    <label for="subject-name">科目名稱</label>
                    <input type="text" id="subject-name" placeholder="請輸入科目名稱">
                </div>
                <div class="input-group">
                    <label for="paper-title">試卷標題</label>
                    <input type="text" id="paper-title" placeholder="請輸入試卷標題">
                </div>
            </div>
            
            <!-- 試卷結構區域 -->
            <div class="section">
                <div class="section-title">
                    <span>試卷結構</span>
                    <button id="add-part-btn" class="btn-success">添加部分</button>
                </div>
                <div class="parts-container" id="parts-container">
                    <!-- 部分將在這裡動態添加 -->
                </div>
            </div>
            
            <!-- 總分顯示區域 -->
            <div class="totals">
                <h3>總分統計</h3>
                <div>總分: <span id="total-score">0</span></div>
                <div>得分: <span id="obtained-score">0</span></div>
                <div>得分率: <span id="score-percentage">0%</span></div>
            </div>
            
            <!-- 操作按鈕 -->
            <div class="action-buttons">
                <button id="save-btn" class="btn-success">儲存試卷</button>
                <button id="reset-btn" class="btn-danger">重置</button>
                <button id="view-list-btn" class="btn-secondary">查看試卷列表</button>
            </div>
        </div>
        
        <!-- 試卷列表頁面 -->
        <div class="tab-content" id="list-tab">
            <div class="section">
                <div class="section-title">
                    <span>已儲存的試卷</span>
                    <button id="back-to-create" class="btn-secondary">返回創建試卷</button>
                </div>
                <div class="paper-list" id="paper-list">
                    <!-- 試卷列表將在這裡動態添加 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局變量
        let parts = [];
        let currentPaperId = null;
        
        // DOM 加載完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加載儲存的數據
            loadSavedData();
            
            // 添加部分按鈕事件
            document.getElementById('add-part-btn').addEventListener('click', addPart);
            
            // 儲存按鈕事件
            document.getElementById('save-btn').addEventListener('click', savePaper);
            
            // 重置按鈕事件
            document.getElementById('reset-btn').addEventListener('click', resetData);
            
            // 查看列表按鈕事件
            document.getElementById('view-list-btn').addEventListener('click', function() {
                switchTab('list');
            });
            
            // 返回創建按鈕事件
            document.getElementById('back-to-create').addEventListener('click', function() {
                switchTab('create');
            });
            
            // 標籤頁切換事件
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            // 初始添加一個部分
            if (parts.length === 0) {
                addPart();
            }
            
            // 渲染試卷列表
            renderPaperList();
        });
        
        // 切換標籤頁
        function switchTab(tabName) {
            // 更新標籤頁狀態
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
            
            // 更新內容區域
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // 如果是列表頁，重新渲染列表
            if (tabName === 'list') {
                renderPaperList();
            }
        }
        
        // 添加部分
        function addPart() {
            const partId = Date.now(); // 使用時間戳作為唯一ID
            const part = {
                id: partId,
                name: `第${parts.length + 1}部分`,
                questions: []
            };
            
            parts.push(part);
            renderParts();
            
            // 自動添加一個題目到新部分
            addQuestion(partId);
        }
        
        // 刪除部分
        function deletePart(partId) {
            if (parts.length <= 1) {
                alert('至少需要保留一個部分！');
                return;
            }
            
            parts = parts.filter(part => part.id !== partId);
            renderParts();
            updateTotals();
        }
        
        // 添加題目
        function addQuestion(partId) {
            const part = parts.find(p => p.id === partId);
            if (!part) return;
            
            const questionId = Date.now();
            part.questions.push({
                id: questionId,
                number: part.questions.length + 1,
                score: 0,
                obtained: 0
            });
            
            renderParts();
            updateTotals();
        }
        
        // 刪除題目
        function deleteQuestion(partId, questionId) {
            const part = parts.find(p => p.id === partId);
            if (!part) return;
            
            if (part.questions.length <= 1) {
                alert('至少需要保留一個題目！');
                return;
            }
            
            part.questions = part.questions.filter(q => q.id !== questionId);
            
            // 重新編號
            part.questions.forEach((q, index) => {
                q.number = index + 1;
            });
            
            renderParts();
            updateTotals();
        }
        
        // 計算部分總分
        function calculatePartTotal(part) {
            let totalScore = 0;
            let obtainedScore = 0;
            
            part.questions.forEach(question => {
                totalScore += question.score;
                obtainedScore += question.obtained;
            });
            
            return {
                totalScore,
                obtainedScore
            };
        }
        
        // 渲染所有部分
        function renderParts() {
            const container = document.getElementById('parts-container');
            container.innerHTML = '';
            
            parts.forEach(part => {
                const partTotals = calculatePartTotal(part);
                const partElement = document.createElement('div');
                partElement.className = 'part';
                
                partElement.innerHTML = `
                    <div class="part-header">
                        <div class="part-title">
                            <input type="text" value="${part.name}" onchange="updatePartName(${part.id}, this.value)" placeholder="部分名稱">
                        </div>
                        <div class="part-total">
                            部分總分: ${partTotals.obtainedScore} / ${partTotals.totalScore}
                        </div>
                        <div>
                            <button onclick="addQuestion(${part.id})" class="btn-success">添加題目</button>
                            <button onclick="deletePart(${part.id})" class="btn-danger">刪除部分</button>
                        </div>
                    </div>
                    <div class="questions-container" id="questions-${part.id}">
                        ${renderQuestions(part)}
                    </div>
                `;
                
                container.appendChild(partElement);
            });
        }
        
        // 渲染題目
        function renderQuestions(part) {
            return part.questions.map(question => `
                <div class="question">
                    <div class="question-number">${question.number}.</div>
                    <div>滿分:</div>
                    <input type="number" class="question-score" value="${question.score}" min="0" step="0.5" 
                           onchange="updateQuestionScore(${part.id}, ${question.id}, this.value)">
                    <div>得分:</div>
                    <input type="number" class="question-obtained" value="${question.obtained}" min="0" step="0.5" 
                           onchange="updateQuestionObtained(${part.id}, ${question.id}, this.value)">
                    <button onclick="deleteQuestion(${part.id}, ${question.id})" class="delete-btn">×</button>
                </div>
            `).join('');
        }
        
        // 更新部分名稱
        function updatePartName(partId, name) {
            const part = parts.find(p => p.id === partId);
            if (part) {
                part.name = name;
            }
        }
        
        // 更新題目分數
        function updateQuestionScore(partId, questionId, score) {
            const part = parts.find(p => p.id === partId);
            if (!part) return;
            
            const question = part.questions.find(q => q.id === questionId);
            if (question) {
                question.score = parseFloat(score) || 0;
                updateTotals();
                renderParts(); // 重新渲染以更新部分總分
            }
        }
        
        // 更新題目得分
        function updateQuestionObtained(partId, questionId, obtained) {
            const part = parts.find(p => p.id === partId);
            if (!part) return;
            
            const question = part.questions.find(q => q.id === questionId);
            if (question) {
                question.obtained = parseFloat(obtained) || 0;
                updateTotals();
                renderParts(); // 重新渲染以更新部分總分
            }
        }
        
        // 更新總分
        function updateTotals() {
            let totalScore = 0;
            let obtainedScore = 0;
            
            parts.forEach(part => {
                part.questions.forEach(question => {
                    totalScore += question.score;
                    obtainedScore += question.obtained;
                });
            });
            
            const percentage = totalScore > 0 ? ((obtainedScore / totalScore) * 100).toFixed(2) : 0;
            
            document.getElementById('total-score').textContent = totalScore;
            document.getElementById('obtained-score').textContent = obtainedScore;
            document.getElementById('score-percentage').textContent = `${percentage}%`;
        }
        
        // 儲存試卷
        function savePaper() {
            const subjectName = document.getElementById('subject-name').value;
            const paperTitle = document.getElementById('paper-title').value;
            
            if (!subjectName || !paperTitle) {
                alert('請填寫科目名稱和試卷標題！');
                return;
            }
            
            // 生成試卷ID
            const paperId = currentPaperId || Date.now();
            
            const paperData = {
                id: paperId,
                subjectName,
                paperTitle,
                parts: JSON.parse(JSON.stringify(parts)), // 深拷貝
                lastSaved: new Date().toISOString(),
                totals: {
                    totalScore: document.getElementById('total-score').textContent,
                    obtainedScore: document.getElementById('obtained-score').textContent,
                    percentage: document.getElementById('score-percentage').textContent
                }
            };
            
            // 獲取現有試卷列表
            let papers = JSON.parse(localStorage.getItem('examPapers')) || [];
            
            // 檢查是否已存在相同ID的試卷
            const existingIndex = papers.findIndex(paper => paper.id === paperId);
            if (existingIndex !== -1) {
                // 更新現有試卷
                papers[existingIndex] = paperData;
            } else {
                // 添加新試卷
                papers.push(paperData);
            }
            
            // 儲存到本地存儲
            localStorage.setItem('examPapers', JSON.stringify(papers));
            
            // 更新當前試卷ID
            currentPaperId = paperId;
            
            alert('試卷已成功儲存！');
            
            // 渲染試卷列表
            renderPaperList();
        }
        
        // 渲染試卷列表
        function renderPaperList() {
            const paperList = document.getElementById('paper-list');
            paperList.innerHTML = '';
            
            const papers = JSON.parse(localStorage.getItem('examPapers')) || [];
            
            if (papers.length === 0) {
                paperList.innerHTML = '<p>尚未儲存任何試卷</p>';
                return;
            }
            
            papers.forEach(paper => {
                const paperElement = document.createElement('div');
                paperElement.className = 'paper-item';
                
                // 格式化日期
                const savedDate = new Date(paper.lastSaved);
                const formattedDate = `${savedDate.getFullYear()}/${savedDate.getMonth()+1}/${savedDate.getDate()} ${savedDate.getHours()}:${savedDate.getMinutes().toString().padStart(2, '0')}`;
                
                paperElement.innerHTML = `
                    <div class="paper-info">
                        <div class="paper-name">${paper.subjectName} - ${paper.paperTitle}</div>
                        <div class="paper-details">
                            總分: ${paper.totals.totalScore} | 得分: ${paper.totals.obtainedScore} | 得分率: ${paper.totals.percentage} | 儲存時間: ${formattedDate}
                        </div>
                    </div>
                    <div class="paper-actions">
                        <button class="btn-success" onclick="loadPaper(${paper.id})">載入</button>
                        <button class="btn-secondary" onclick="duplicatePaper(${paper.id})">複製</button>
                        <button class="btn-danger" onclick="deletePaper(${paper.id})">刪除</button>
                    </div>
                `;
                
                paperList.appendChild(paperElement);
            });
        }
        
        // 載入試卷
        function loadPaper(paperId) {
            const papers = JSON.parse(localStorage.getItem('examPapers')) || [];
            const paper = papers.find(p => p.id === paperId);
            
            if (paper) {
                // 設置當前試卷ID
                currentPaperId = paper.id;
                
                // 載入科目和標題
                document.getElementById('subject-name').value = paper.subjectName;
                document.getElementById('paper-title').value = paper.paperTitle;
                
                // 載入部分和題目
                parts = JSON.parse(JSON.stringify(paper.parts)); // 深拷貝
                
                // 重新渲染
                renderParts();
                updateTotals();
                
                // 切換到創建頁面
                switchTab('create');
                
                alert('試卷載入成功！');
            }
        }
        
        // 複製試卷
        function duplicatePaper(paperId) {
            const papers = JSON.parse(localStorage.getItem('examPapers')) || [];
            const paper = papers.find(p => p.id === paperId);
            
            if (paper) {
                // 創建副本
                const duplicatedPaper = {
                    ...paper,
                    id: Date.now(), // 新ID
                    paperTitle: `${paper.paperTitle} (副本)`,
                    lastSaved: new Date().toISOString()
                };
                
                // 添加到列表
                papers.push(duplicatedPaper);
                localStorage.setItem('examPapers', JSON.stringify(papers));
                
                // 重新渲染列表
                renderPaperList();
                
                alert('試卷複製成功！');
            }
        }
        
        // 刪除試卷
        function deletePaper(paperId) {
            if (confirm('確定要刪除此試卷嗎？此操作無法復原！')) {
                let papers = JSON.parse(localStorage.getItem('examPapers')) || [];
                papers = papers.filter(paper => paper.id !== paperId);
                localStorage.setItem('examPapers', JSON.stringify(papers));
                
                // 如果刪除的是當前載入的試卷，重置當前ID
                if (currentPaperId === paperId) {
                    currentPaperId = null;
                }
                
                // 重新渲染列表
                renderPaperList();
                
                alert('試卷刪除成功！');
            }
        }
        
        // 加載儲存的數據（用於初始化）
        function loadSavedData() {
            // 這裡可以載入預設數據或上次編輯的數據
        }
        
        // 重置數據
        function resetData() {
            if (confirm('確定要重置所有數據嗎？此操作無法撤銷！')) {
                document.getElementById('subject-name').value = '';
                document.getElementById('paper-title').value = '';
                parts = [];
                currentPaperId = null;
                addPart();
                updateTotals();
            }
        }
    </script>
</body>
</html>